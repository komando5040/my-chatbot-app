name: Build Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install system dependencies
      run: |
        sudo apt update
        
        # Ù†ØµØ¨ Ù‡Ù…Ù‡ Ø¨Ø³ØªÙ‡â€ŒÙ‡Ø§ Ø¨Ù‡â€ŒØµÙˆØ±Øª ÛŒÚ©ÛŒâ€ŒÛŒÚ©ÛŒ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² ØªÙˆÙ‚Ù Ú©Ù„ ÙØ±Ø§ÛŒÙ†Ø¯
        for pkg in git zip unzip openjdk-17-jdk python3-pip autoconf libtool pkg-config zlib1g-dev libncurses5-dev libncursesw5-dev cmake libffi-dev libssl-dev; do
          echo "ğŸ“¦ Installing $pkg ..."
          sudo apt-get install -y $pkg || echo "âš ï¸  Warning: Failed to install $pkg, continuing..."
        done

        # ØªÙ„Ø§Ø´ ÙˆÛŒÚ˜Ù‡ Ø¨Ø±Ø§ÛŒ Ù†ØµØ¨ libtinfo5 (Ø§Ú¯Ø± Ù†ÛŒØ§Ø² Ø¨Ø§Ø´Ø¯)
        if ! dpkg -l | grep -q libtinfo5; then
          echo "ğŸ” libtinfo5 not found. Attempting to install from Ubuntu 22.04 repository..."
          # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù…Ø®Ø²Ù† Ubuntu 22.04 (Jammy) Ø¨Ø§ Ø§ÙˆÙ„ÙˆÛŒØª Ù¾Ø§ÛŒÛŒÙ†
          sudo add-apt-repository -y 'deb http://archive.ubuntu.com/ubuntu jammy main universe' || true
          sudo apt update
          sudo apt-get install -y libtinfo5 || echo "âš ï¸  Could not install libtinfo5. Build might still work."
        else
          echo "âœ… libtinfo5 is already installed."
        fi

    - name: Install Cython and buildozer
      run: |
        pip install --upgrade pip
        pip install cython buildozer

    - name: Cache buildozer directory
      uses: actions/cache@v4
      with:
        path: .buildozer
        key: ${{ runner.os }}-buildozer-${{ hashFiles('buildozer.spec') }}
        restore-keys: |
          ${{ runner.os }}-buildozer-

    - name: Build with buildozer
      run: |
        buildozer -v android debug

    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: my-chatbot-apk
        path: bin/*.apk
