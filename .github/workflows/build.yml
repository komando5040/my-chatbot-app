name: Build Android APK (Final Version)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create main.py
        run: |
          cat > main.py << 'EOF'
          from kivy.app import App
          from kivy.uix.boxlayout import BoxLayout
          from kivy.uix.label import Label
          from kivy.uix.textinput import TextInput
          from kivy.uix.button import Button
          from kivy.uix.scrollview import ScrollView
          from kivy.core.window import Window
          from kivy.clock import Clock

          Window.clearcolor = (0.1, 0.1, 0.1, 1)

          class ChatApp(App):
              def build(self):
                  main = BoxLayout(orientation='vertical', padding=10, spacing=10)
                  
                  # Chat area
                  self.scroll = ScrollView()
                  self.chat_area = BoxLayout(orientation='vertical', size_hint_y=None, spacing=5)
                  self.chat_area.bind(minimum_height=self.chat_area.setter('height'))
                  self.scroll.add_widget(self.chat_area)
                  
                  # Input area
                  bottom = BoxLayout(size_hint_y=0.1, spacing=5)
                  self.input = TextInput(
                      multiline=False,
                      background_color=(0.2, 0.2, 0.2, 1),
                      foreground_color=(1, 1, 1, 1)
                  )
                  send_btn = Button(
                      text='Ø§Ø±Ø³Ø§Ù„',
                      size_hint_x=0.2,
                      background_color=(0.2, 0.6, 1, 1)
                  )
                  send_btn.bind(on_press=self.send_message)
                  
                  bottom.add_widget(self.input)
                  bottom.add_widget(send_btn)
                  
                  main.add_widget(self.scroll)
                  main.add_widget(bottom)
                  
                  # Welcome message
                  self.add_message("ðŸ¤– Ø³Ù„Ø§Ù…! Ú†Ø·ÙˆØ± Ù…ÛŒØªÙˆÙ†Ù… Ú©Ù…Ú©Øª Ú©Ù†Ù…ØŸ", False)
                  
                  return main
              
              def send_message(self, instance):
                  msg = self.input.text.strip()
                  if not msg:
                      return
                  
                  self.add_message(f"ðŸ‘¤ {msg}", True)
                  self.input.text = ""
                  
                  # Auto response
                  response = "ðŸ¤– "
                  if any(word in msg.lower() for word in ['Ø³Ù„Ø§Ù…', 'hi', 'hello', 'Ø¯Ø±ÙˆØ¯']):
                      response += "Ø³Ù„Ø§Ù…! Ø­Ø§Ù„Øª Ú†Ø·ÙˆØ±Ù‡ØŸ"
                  elif any(word in msg.lower() for word in ['Ú†Ø·ÙˆØ±ÛŒ', 'Ú†Ø·ÙˆØ±ÛŒÙ†', 'how are you']):
                      response += "Ù…Ù† Ø®ÙˆØ¨Ù…ØŒ Ù…Ù…Ù†ÙˆÙ†! ØªÙˆ Ú†Ø·ÙˆØ±ÛŒØŸ"
                  elif any(word in msg.lower() for word in ['Ø®ÙˆØ¨ÛŒ', 'good']):
                      response += "Ø¢Ø±Ù‡ Ø®ÙˆØ¨Ù…ØŒ Ù…Ø±Ø³ÛŒ!"
                  else:
                      response += "Ù…ØªÙˆØ¬Ù‡ Ù†Ø´Ø¯Ù…. Ù…ÛŒØ´Ù‡ ÛŒÙ‡ Ú†ÛŒØ² Ø¯ÛŒÚ¯Ù‡ Ø¨Ú¯ÛŒØŸ"
                  
                  Clock.schedule_once(lambda dt: self.add_message(response, False), 0.5)
              
              def add_message(self, text, is_user):
                  label = Label(
                      text=text,
                      size_hint_y=None,
                      height=40,
                      color=(1, 1, 1, 1),
                      halign='right' if is_user else 'left',
                      valign='middle',
                      text_size=(Window.width - 40, None)
                  )
                  label.bind(texture_size=label.setter('size'))
                  self.chat_area.add_widget(label)
                  Clock.schedule_once(lambda dt: setattr(self.scroll, 'scroll_y', 0), 0.1)

          if __name__ == '__main__':
              ChatApp().run()
          EOF

      - name: Create buildozer.spec
        run: |
          cat > buildozer.spec << 'EOF'
          [app]
          title = My ChatGPT
          package.name = mychatbot
          package.domain = org.example
          source.dir = .
          source.include_exts = py,png,jpg,kv,atlas
          version = 0.1
          requirements = python3,kivy==2.1.0
          orientation = portrait
          osx.python_version = 3
          osx.kivy_version = 2.1.0
          fullscreen = 0

          [buildozer]
          log_level = 2
          warn_on_root = 1

          [buildozer.settings]
          android.accept_sdk_license = True
          android.ndk = 25b
          android.sdk = 24
          android.minapi = 21
          android.api = 31
          android.arch = arm64-v8a
          EOF

      - name: Install buildozer and dependencies
        run: |
          sudo apt update
          sudo apt install -y python3-pip python3-dev python3-venv git zip unzip openjdk-17-jdk autoconf libtool pkg-config zlib1g-dev libncurses5-dev libncursesw5-dev cmake libffi-dev libssl-dev
          pip3 install --user --upgrade pip
          pip3 install --user cython buildozer
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Build APK (Auto Yes)
        run: |
          # Ø§ÛŒÙ† Ø®Ø· Ù…Ø¹Ø¬Ø²Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ù‡ - Ø¨Ù‡ buildozer Ù…ÛŒâ€ŒÚ¯Ù‡ Ø¨Ù‡ Ù‡Ù…Ù‡ Ø³ÙˆØ§Ù„Ø§Øª "yes" Ø¨Ø¯Ù‡
          yes | buildozer android debug || true
          
          # Ø§Ú¯Ù‡ ÙØ§ÛŒÙ„ Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯ØŒ Ø¨Ø§Ø´Ù‡. Ø§Ú¯Ù‡ Ù†Ù‡ØŒ ÛŒÙ‡ Ø±Ø§Ù‡ Ø¯ÛŒÚ¯Ù‡
          if [ -z "$(ls bin/*.apk 2>/dev/null)" ]; then
            echo "âš ï¸ Buildozer failed, trying direct p4a..."
            
            # Ù†ØµØ¨ python-for-android Ù…Ø³ØªÙ‚ÛŒÙ…
            pip3 install --user git+https://github.com/kivy/python-for-android.git
            
            # Ø³Ø§Ø®ØªÙ† Ø¨Ø§ p4a Ù…Ø³ØªÙ‚ÛŒÙ…
            yes | python3 -m pythonforandroid.toolchain create \
              --dist_name mychatbot \
              --version 0.1 \
              --package org.example.mychatbot \
              --requirements python3,kivy==2.1.0 \
              --arch arm64-v8a \
              --api 31 \
              --ndk-version 25b \
              --sdk-version 31 \
              --bootstrap sdl2 \
              --copy-libs \
              --release \
              --ndk-dir $ANDROID_NDK_ROOT \
              --sdk-dir $ANDROID_HOME
              
            # Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù† ÙØ§ÛŒÙ„ Ø¨Ù‡ Ù¾ÙˆØ´Ù‡ bin
            mkdir -p bin
            cp ~/*.apk bin/ 2>/dev/null || true
          fi

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: my-chatbot-apk
          path: bin/*.apk
        if: success() or failure()  # Ù‡Ù…ÛŒØ´Ù‡ Ø¢Ù¾Ù„ÙˆØ¯ Ú©Ù†ØŒ Ø­ØªÛŒ Ø§Ú¯Ù‡ Ø¨ÛŒÙ„Ø¯ Ø¨Ø§ Ø®Ø·Ø§ ØªÙ…ÙˆÙ… Ø¨Ø´Ù‡
