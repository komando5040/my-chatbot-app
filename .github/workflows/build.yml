name: Build Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install system dependencies
      run: |
        sudo apt update
        # Ø¨Ø³ØªÙ‡â€ŒÙ‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ Ø¨Ø±Ø§ÛŒ Ø¨ÛŒÙ„Ø¯
        for pkg in git zip unzip openjdk-17-jdk-headless python3-pip autoconf libtool pkg-config zlib1g-dev libncurses5-dev libncursesw5-dev cmake libffi-dev libssl-dev; do
          echo "ğŸ“¦ Installing $pkg ..."
          sudo apt-get install -y $pkg || echo "âš ï¸ Warning: Failed to install $pkg, continuing..."
        done

        # ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ù†ØµØ¨ libtinfo5 (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
        if ! dpkg -l | grep -q libtinfo5; then
          echo "ğŸ” libtinfo5 not found. Attempting to install from Ubuntu 22.04 repository..."
          sudo add-apt-repository -y 'deb http://archive.ubuntu.com/ubuntu jammy main universe' || true
          sudo apt update
          sudo apt-get install -y libtinfo5 || echo "âš ï¸ Could not install libtinfo5. Build might still work."
        fi

    - name: Install Android SDK command-line tools
      run: |
        # Ø§ÛŒØ¬Ø§Ø¯ Ù…Ø³ÛŒØ± SDK
        mkdir -p $HOME/.buildozer/android/platform/android-sdk
        cd $HOME/.buildozer/android/platform
        # Ø¯Ø§Ù†Ù„ÙˆØ¯ cmdline-tools
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
        unzip -q commandlinetools-linux-9477386_latest.zip
        mv cmdline-tools android-sdk/cmdline-tools
        rm commandlinetools-linux-9477386_latest.zip
        # ØªÙ†Ø¸ÛŒÙ… Ù…ØªØºÛŒØ± Ù…Ø­ÛŒØ·ÛŒ
        echo "ANDROID_SDK_ROOT=$HOME/.buildozer/android/platform/android-sdk" >> $GITHUB_ENV
        echo "$HOME/.buildozer/android/platform/android-sdk/cmdline-tools/bin" >> $GITHUB_PATH

    - name: Accept Android SDK licenses
      run: |
        # Ù¾Ø°ÛŒØ±Ø´ Ø®ÙˆØ¯Ú©Ø§Ø± Ù‡Ù…Ù‡ Ù„Ø§ÛŒØ³Ù†Ø³â€ŒÙ‡Ø§
        yes | sdkmanager --licenses --sdk_root=$ANDROID_SDK_ROOT || true
        # Ù†ØµØ¨ build-tools Ùˆ Ù¾Ù„ØªÙØ±Ù… Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø²
        sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0" --sdk_root=$ANDROID_SDK_ROOT

    - name: Install Cython and buildozer
      run: |
        pip install --upgrade pip
        pip install cython buildozer

    - name: Cache buildozer directory
      uses: actions/cache@v4
      with:
        path: .buildozer
        key: ${{ runner.os }}-buildozer-${{ hashFiles('buildozer.spec') }}
        restore-keys: |
          ${{ runner.os }}-buildozer-

    - name: Build with buildozer
      run: |
        # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² SDK Ù†ØµØ¨â€ŒØ´Ø¯Ù‡
        export ANDROID_SDK_ROOT=$HOME/.buildozer/android/platform/android-sdk
        buildozer -v android debug

    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: my-chatbot-apk
        path: bin/*.apk
