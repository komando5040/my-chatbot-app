name: Build Android APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: kivy/buildozer:latest

    steps:
      - uses: actions/checkout@v4

      - name: Create main.py
        run: |
          cat > main.py << 'EOF'
          from kivy.app import App
          from kivy.uix.boxlayout import BoxLayout
          from kivy.uix.label import Label
          from kivy.uix.textinput import TextInput
          from kivy.uix.button import Button
          from kivy.uix.scrollview import ScrollView
          from kivy.core.window import Window

          Window.clearcolor = (0.1, 0.1, 0.1, 1)

          class ChatApp(App):
              def build(self):
                  main = BoxLayout(orientation='vertical')
                  
                  self.scroll = ScrollView()
                  self.chat_area = BoxLayout(orientation='vertical', size_hint_y=None)
                  self.chat_area.bind(minimum_height=self.chat_area.setter('height'))
                  self.scroll.add_widget(self.chat_area)
                  
                  bottom = BoxLayout(size_hint_y=0.1)
                  self.input = TextInput(multiline=False)
                  btn = Button(text='Send', size_hint_x=0.2)
                  btn.bind(on_press=self.send_message)
                  
                  bottom.add_widget(self.input)
                  bottom.add_widget(btn)
                  
                  main.add_widget(self.scroll)
                  main.add_widget(bottom)
                  
                  self.add_message("Hello! How can I help?", False)
                  
                  return main
              
              def send_message(self, instance):
                  msg = self.input.text.strip()
                  if msg:
                      self.add_message(f"you: {msg}", True)
                      self.input.text = ""
                      self.add_message("Robot: Hello! How are you?", False)
              
              def add_message(self, text, is_user):
                  label = Label(
                      text=text,
                      size_hint_y=None,
                      height=30,
                      halign='right' if is_user else 'left'
                  )
                  self.chat_area.add_widget(label)
                  self.scroll.scroll_y = 0

          if __name__ == '__main__':
              ChatApp().run()
          EOF

      - name: Create buildozer.spec
        run: |
          cat > buildozer.spec << 'EOF'
          [app]
          title = My ChatGPT
          package.name = mychatbot
          package.domain = org.example
          source.dir = .
          source.include_exts = py,png,jpg,kv,atlas
          version = 0.1
          requirements = python3,kivy==2.1.0
          orientation = portrait
          fullscreen = 0

          [buildozer]
          log_level = 2
          android.accept_sdk_license = True
          android.ndk = 25b
          android.sdk = 24
          android.minapi = 21
          android.api = 31
          android.arch = arm64-v8a
          EOF

      - name: Build APK
        run: |
          yes | buildozer android debug

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: my-chatbot-apk
          path: bin/*.apk
